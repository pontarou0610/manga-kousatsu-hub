{{- $activeSlugs := slice -}}
{{- range .Site.Data.series -}}
  {{- if not .manual -}}
    {{- $activeSlugs = $activeSlugs | append .slug -}}
  {{- end -}}
{{- end -}}

{{- $staticSections := slice "about" "privacy" "contact" -}}

{{- $urls := slice -}}
{{- $urls = $urls | append .Site.Home -}}

{{- with .Site.GetPage "/search" -}}
  {{- $urls = $urls | append . -}}
{{- end -}}

{{- with .Site.GetPage "/posts" -}}
  {{- $urls = $urls | append . -}}
{{- end -}}

{{- range where .Site.Pages "Section" "in" $staticSections -}}
  {{- if in (slice "page" "section") .Kind -}}
    {{- $urls = $urls | append . -}}
  {{- end -}}
{{- end -}}

{{- range where .Site.RegularPages "Section" "series" -}}
  {{- if and .File (in $activeSlugs .File.ContentBaseName) -}}
    {{- $urls = $urls | append . -}}
  {{- end -}}
{{- end -}}

{{- range where (where .Site.RegularPages "Type" "posts") "Params.series_slug" "in" $activeSlugs -}}
  {{- if and (not .Draft) (ne (.Params.noindex | default false) true) -}}
    {{- $urls = $urls | append . -}}
  {{- end -}}
{{- end -}}

<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9" xmlns:xhtml="http://www.w3.org/1999/xhtml">
  {{- range $urls -}}
  <url>
    <loc>{{ .Permalink }}</loc>
    {{- if not .Lastmod.IsZero -}}
    <lastmod>{{ .Lastmod.Format "2006-01-02T15:04:05Z07:00" }}</lastmod>
    {{- end -}}
  </url>
  {{- end -}}
</urlset>
