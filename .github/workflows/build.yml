name: Build & Deploy (Hugo)

on:
  schedule:
    - cron: "0 0 * * *"      # Once daily (UTC 00:00)
  workflow_dispatch:
  push:
    branches: [ main ]

concurrency:
  group: build-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      # Cost-first: use mini by default, and allow automatic upgrade/fallback.
      OPENAI_MODEL_CANDIDATES: gpt-5-mini,gpt-5.1,gpt-4.1-mini,gpt-4.1
      # Disable fallback topic generation in CI to avoid spending tokens daily when no new RSS.
      GENERATE_FALLBACK_TOPICS: "false"
      # Throttle RSS processing per run (cost control).
      RSS_MAX_ENTRIES: "1"
      # Cap newly created posts per series per run (cost control).
      MAX_POSTS_PER_SERIES_PER_RUN: "1"
      # Hard cap of newly created posts per run (must be >= number of active series).
      MAX_POSTS_PER_RUN: "50"
      # Catch up using data/backlog/<series>.yaml.
      GENERATE_BACKLOG_ENTRIES: "true"
      BACKLOG_ENTRIES_PER_RUN: "1"
      # Focus on spoiler posts while catching up.
      GENERATE_SPOILER_POSTS: "true"
      GENERATE_INSIGHT_POSTS: "false"
      # Web research (headlines/OGP only) for allowed sources.
      RESEARCH_ENABLED: "true"
      RESEARCH_TIMEOUT_SEC: "8"
      RESEARCH_MAX_LINKS: "4"
      RESEARCH_PER_SOURCE: "1"
      PEXELS_API_KEY: ${{ secrets.PEXELS_API_KEY }}
      AMAZON_TAG: ${{ secrets.AMAZON_TAG }}
      GA4_ID: ${{ secrets.GA4_ID || '' }}
    steps:
      - uses: actions/checkout@v4

      - name: Restore state cache
        uses: actions/cache@v4
        with:
          path: data/state.json
          key: state-${{ github.ref }}

      - name: Ensure state file
        shell: pwsh
        run: |
          if (!(Test-Path data)) { New-Item -ItemType Directory -Path data | Out-Null }
          $statePath = "data/state.json"
          if (!(Test-Path $statePath)) {
            '{"entries":[],"glossary_progress":{},"backlog_progress":{},"chapter_progress":{}}' | Out-File $statePath -Encoding UTF8
          } else {
            try {
              $state = Get-Content $statePath -Raw | ConvertFrom-Json
            } catch {
              $state = $null
            }
            if ($null -eq $state) { $state = [pscustomobject]@{} }
            if (-not ($state.PSObject.Properties.Name -contains "entries")) { $state | Add-Member -NotePropertyName entries -NotePropertyValue @() }
            if (-not ($state.PSObject.Properties.Name -contains "glossary_progress")) { $state | Add-Member -NotePropertyName glossary_progress -NotePropertyValue @{} }
            if (-not ($state.PSObject.Properties.Name -contains "backlog_progress")) { $state | Add-Member -NotePropertyName backlog_progress -NotePropertyValue @{} }
            if (-not ($state.PSObject.Properties.Name -contains "chapter_progress")) { $state | Add-Member -NotePropertyName chapter_progress -NotePropertyValue @{} }
            $state | ConvertTo-Json -Depth 10 | Set-Content $statePath -Encoding UTF8
          }

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: "0.134.2"
          extended: true

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r scripts/requirements.txt

      - name: Update backlog (from sources)
        run: python scripts/update_backlog_from_sources.py

      - name: Generate posts
        run: python scripts/generate_posts.py

      - name: Update glossaries
        run: python scripts/update_all_glossaries.py

      - name: Show generated changes
        run: |
          git status -sb
          git diff --stat || true

      - name: Commit generated content
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          branch: main
          commit_message: "chore: 自動生成コンテンツ更新"
          file_pattern: |
            content/**
            data/state.json
            data/glossary/**
            static/ogp/**
            templates/**
            scripts/**

      - name: Build
        run: hugo --cleanDestinationDir --minify

      - name: Deploy to Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          publish_branch: gh-pages
